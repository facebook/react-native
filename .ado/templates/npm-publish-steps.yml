parameters:
  # If this is a new stable branch, change `publishTag` to `latest` when going stable
  publishTag: 'v0.76-stable'

steps:
  - template: /.ado/templates/configure-git.yml@self

  - script: |
      yarn install
    displayName: Install npm dependencies

  - script: |
      node .ado/scripts/prepublish-check.mjs --verbose --tag ${{ parameters['publishTag'] }}
    displayName: Verify release config

  - script: |
      echo Target branch: $(System.PullRequest.TargetBranch)
      yarn nx release --dry-run --verbose
    displayName: Version and publish packages (dry run)
    condition: and(succeeded(), ne(variables['publish_react_native_macos'], '1'))

  - script: |
      git switch $(Build.SourceBranchName)
      yarn nx release --skip-publish --verbose
    env:
      GITHUB_TOKEN: $(githubAuthToken)
    displayName: Version Packages and Github Release
    condition: and(succeeded(), eq(variables['publish_react_native_macos'], '1'))

  - script: |
      echo "//registry.npmjs.org/:_authToken=$(npmAuthToken)" > ~/.npmrc
      yarn nx release publish --tag ${{ parameters['publishTag'] }} --excludeTaskDependencies 
    displayName: Publish packages
    condition: and(succeeded(), eq(variables['publish_react_native_macos'], '1'))

  - script: |
      rm -f ~/.npmrc
    displayName: Remove npmrc if it exists
    condition: always()
