name: Test Hermes V1 with nightly on iOS

on:
  workflow_call:
    inputs:
      retry-count:
        description: 'Number of times to retry the build on failure'
        required: false
        type: number
        default: 3

jobs:
  test-hermes-v1-ios:
    name: Test Hermes V1 on iOS
    runs-on: macos-15-large
    strategy:
      matrix:
        flavor: [debug, release]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.14.0'
          cache: yarn

      - name: Prepare capitalized flavor
        id: prepare-flavor
        shell: bash
        run: |
          CAPITALIZED_FLAVOR=$(echo "${{ matrix.flavor }}" | awk '{print toupper(substr($0, 1, 1)) substr($0, 2)}')
          echo "capitalized_flavor=$CAPITALIZED_FLAVOR" >> $GITHUB_OUTPUT

      - name: Prepare the app with Hermes V1
        uses: ./.github/actions/prepare-hermes-v1-app
        with:
          retry-count: ${{ inputs.retry-count }}

      - name: Setup xcode
        uses: maxim-lobanov/setup-xcode@v1

      - name: Build iOS with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 45
          max_attempts: ${{ inputs.retry-count }}
          retry_wait_seconds: 30
          shell: bash
          command: |
            cd /tmp/RNApp/ios
            bundle install
            RCT_HERMES_V1_ENABLED=1 bundle exec pod install
            xcodebuild build \
              -workspace "RNApp.xcworkspace" \
              -scheme "RNApp" \
              -configuration "${{ steps.prepare-flavor.outputs.capitalized_flavor }}" \
              -sdk "iphonesimulator" \
              -destination "generic/platform=iOS Simulator" \
              -derivedDataPath "/tmp/RNApp" \
              -quiet
          on_retry_command: |
            echo "Cleaning up for iOS retry..."
            cd /tmp/RNApp/ios
            rm -rf Pods Podfile.lock build
            rm -rf ~/Library/Developer/Xcode/DerivedData/* || true

      - name: Run E2E Tests
        uses: ./.github/actions/maestro-ios
        with:
          app-path: "/tmp/RNApp/Build/Products/${{ steps.prepare-flavor.outputs.capitalized_flavor }}-iphonesimulator/RNApp.app"
          app-id: org.reactjs.native.example.RNApp
          maestro-flow: ./scripts/e2e/.maestro/
          flavor: ${{ steps.prepare-flavor.outputs.capitalized_flavor }}
          working-directory: /tmp/RNApp
