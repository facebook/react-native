import*as e from"../helpers/helpers.js";import*as t from"../types/types.js";import*as n from"../../../core/i18n/i18n.js";import*as i from"../../../core/platform/platform.js";import*as r from"../handlers/handlers.js";import*as s from"../extras/extras.js";import*as a from"../../../third_party/legacy-javascript/legacy-javascript.js";import*as o from"../../../third_party/third-party-web/third-party-web.js";function c({median:e,p10:t},n){if(e<=0)throw new Error("median must be greater than zero");if(t<=0)throw new Error("p10 must be greater than zero");if(t>=e)throw new Error("p10 must be less than the median");if(n<=0)return 1;const i=Math.max(Number.MIN_VALUE,n/e),r=Math.log(i),s=Math.max(Number.MIN_VALUE,t/e),a=(1-function(e){const t=Math.sign(e),n=1/(1+.3275911*(e=Math.abs(e)));return t*(1-n*(.254829592+n*(n*(1.421413741+n*(1.061405429*n-1.453152027))-.284496736))*Math.exp(-e*e))}(.9061938024368232*r/-Math.log(s)))/2;let o;return o=n<=t?Math.max(.9,Math.min(1,a)):n<=e?Math.max(.5,Math.min(.8999999999999999,a)):Math.max(0,Math.min(.49999999999999994,a)),o}function l(e,t,n,i,r){return t+(r-e)*((i-t)/(n-e))}var u=Object.freeze({__proto__:null,getLogNormalScore:c,linearInterpolation:l});function d(e,t,n){if(!t||!n)return null;const i=t.get(n);if(!i)return null;const r=i.model[e];return r instanceof Error?null:r}function g(e){return c({p10:2500,median:4e3},e)}function p(e){return c({p10:200,median:500},e)}function m(e){return c({p10:.1,median:.25},e)}function f(e,t,n=null){const i=[];n?i.push(n):(i.push({pageScope:"url",deviceScope:"ALL"}),i.push({pageScope:"origin",deviceScope:"ALL"}));for(const n of i){const i=`${n.pageScope}-${n.deviceScope}`;let r=e[i]?.record.metrics[t]?.percentiles?.p75;if("string"==typeof r&&(r=Number(r)),"number"==typeof r&&Number.isFinite(r))return{value:r,pageScope:n.pageScope}}return null}function h(t,n,i=null){const r=f(t,n,i);if(r){const t=r.value;return{value:e.Timing.milliToMicro(t),pageScope:r.pageScope}}return null}function v(e,t,n=null){const i=t?.cruxFieldData;if(!i)return null;const r=function(e,t,n,i=null){return e.find((e=>{const r=i?e[`${i.pageScope}-${i.deviceScope}`]?.record.key:(e["url-ALL"]||e["origin-ALL"])?.record.key;return r?.url&&r.url===t||r?.origin&&r.origin===n}))}(i,e.url.href,e.url.origin,n);return r?{fcp:h(r,"first_contentful_paint",n),lcp:h(r,"largest_contentful_paint",n),inp:h(r,"interaction_to_next_paint",n),cls:f(r,"cumulative_layout_shift",n),lcpPhases:{ttfb:h(r,"largest_contentful_paint_image_time_to_first_byte",n),loadDelay:h(r,"largest_contentful_paint_image_resource_load_delay",n),loadDuration:h(r,"largest_contentful_paint_image_resource_load_duration",n),renderDelay:h(r,"largest_contentful_paint_image_element_render_delay",n)}}:null}function y(e,n,i){const r=n.simulate(i),s=new Map;i.traverse((t=>{if("network"!==t.type)return;const n=e.get(t.request.requestId);if(!n)return;const i=t.request.transferSize;s.set(t.request.requestId,i),t.request.transferSize=Math.max(i-n,0)}));const a=n.simulate(i);i.traverse((e=>{if("network"!==e.type)return;const t=s.get(e.request.requestId);void 0!==t&&(e.request.transferSize=t)}));let o=r.timeInMs-a.timeInMs;return o=50*Math.round(o/50),t.Timing.Milli(o)}function S(e,n){if(!n.navigation||!n.lantern)return;if(!e.size)return{FCP:t.Timing.Milli(0),LCP:t.Timing.Milli(0)};const i=n.lantern.simulator,r=n.lantern.metrics.firstContentfulPaint.optimisticGraph,s=n.lantern.metrics.largestContentfulPaint.optimisticGraph;return{FCP:y(e,i,r),LCP:y(e,i,s)}}function T(e){const t=[/^content-encoding$/i,/^x-content-encoding-over-network$/i,/^x-original-content-encoding$/i],n=["gzip","br","deflate","zstd"];return e.args.data.responseHeaders.some((e=>t.some((t=>e.name.match(t)))&&n.includes(e.value)))}function I(e,t,n){if(!e)switch(n){case"Stylesheet":return Math.round(.2*t);case"Script":case"Document":return Math.round(.33*t);default:return Math.round(.5*t)}const{transferSize:i,resourceSize:r}=function(e){return{resourceSize:e.args.data.decodedBodyLength,transferSize:e.args.data.encodedDataLength}}(e);let s=i;if(T(e)||(s=r),e.args.data.resourceType===n)return s;const a=Number.isFinite(r)&&r>0?s/r:1;return Math.round(t*a)}function _(e){if(!e.request)return 1;const t=e.request,n=t.args.data.decodedBodyLength??e.content?.length??0;return I(t,n,"Script")/n}var E,M,w=Object.freeze({__proto__:null,calculateMetricWeightsForSorting:function(t,n){const i={lcp:1/3,inp:1/3,cls:1/3},r=n?.cruxFieldData;if(!r)return i;const s=v(t,n);if(!s)return i;const a=s.lcp?.value??null,o=s.inp?.value??null,c=s.cls?.value??null,l=1-(null!==a?g(e.Timing.microToMilli(a)):0),u=1-(null!==o?p(e.Timing.microToMilli(o)):0),d=1-(null!==c?m(c):0),f=l+u+d;return f?(i.lcp=l/f,i.inp=u/f,i.cls=d/f,i):i},estimateCompressedContentSize:I,estimateCompressionRatioForScript:_,evaluateCLSMetricScore:m,evaluateINPMetricScore:p,evaluateLCPMetricScore:g,getCLS:function(e,t){const n=d("CLSCulprits",e,t);if(!n)return{value:0,worstClusterEvent:null};let i,r=0;for(const e of n.clusters)e.clusterCumulativeScore>r&&(r=e.clusterCumulativeScore,i=e);return{value:r,worstClusterEvent:i??null}},getFieldMetricsForInsightSet:v,getINP:function(e,t){const n=d("InteractionToNextPaint",e,t);return n?.longestInteractionEvent?.dur?{value:n.longestInteractionEvent.dur,event:n.longestInteractionEvent}:null},getInsight:d,getLCP:function(t,n){const i=d("LCPPhases",t,n);return i&&i.lcpMs&&i.lcpEvent?{value:e.Timing.milliToMicro(i.lcpMs),event:i.lcpEvent}:null},isRequestCompressed:T,metricSavingsForWastedBytes:S});!function(e){e.NO_FP="NO_FP",e.NO_LCP="NO_LCP",e.NO_DOCUMENT_REQUEST="NO_DOCUMENT_REQUEST",e.NO_LAYOUT="NO_LAYOUT"}(E||(E={})),function(e){e.ALL="All",e.INP="INP",e.LCP="LCP",e.CLS="CLS"}(M||(M={}));var b=Object.freeze({__proto__:null,get InsightCategory(){return M},get InsightWarning(){return E}});const L={title:"Use efficient cache lifetimes",description:"A long cache lifetime can speed up repeat visits to your page. [Learn more](https://web.dev/uses-long-cache-ttl/).",requestColumn:"Request",cacheTTL:"Cache TTL",noRequestsToCache:"No requests with inefficient cache policies",others:"{PH1} others"},C=n.i18n.registerUIStrings("models/trace/insights/Cache.ts",L),P=n.i18n.getLocalizedString.bind(void 0,C);function R(t){return!e.Network.NON_NETWORK_SCHEMES.includes(t.args.data.protocol)&&Boolean(e.Network.CACHEABLE_STATUS_CODES.has(t.args.data.statusCode)&&e.Network.STATIC_RESOURCE_TYPES.has(t.args.data.resourceType||"Other"))}function N(e,t){if(void 0!==t?.["max-age"])return t["max-age"];const n=e.find((e=>"expires"===e.name))?.value??null;if(n){const e=new Date(n).getTime();return e?Math.ceil((e-Date.now())/1e3):0}return null}function O(e){const t=[0,.2,1,3,8,12,24,48,72,168,8760,1/0],n=e/3600,i=t.findIndex((e=>e>=n));if(i===t.length-1)return 1;if(0===i)return 0;const r=t[i];return l(t[i-1],(i-1)/10,r,i/10,n)}function D(e){const t=new Map;for(const n of e){const e=n.name.toLowerCase();t.get(e)?t.set(e,`${t.get(e)}, ${n.value}`):t.set(e,n.value)}return t}function q(e,t){const n=e?.get("cache-control")??null,i=e?.get("pragma")??null;return!(n||!i?.includes("no-cache"))||!(!t||!(t["must-revalidate"]||t["no-cache"]||t["no-store"]||t.private))}var z=Object.freeze({__proto__:null,UIStrings:L,cachingDisabled:q,computeCacheLifetimeInSeconds:N,generateInsight:function(t,n){const i=t.NetworkRequests.byTime.filter((t=>e.Timing.eventIsInBounds(t,n.bounds))),r=[];let s=0;const a=new Map;for(const t of i){if(!R(t))continue;const n=D(t.args.data.responseHeaders),i=n.get("cache-control")??null,o=e.Network.parseCacheControl(i);if(q(n,o))continue;let c=N(t.args.data.responseHeaders,o);if(null!==c&&(!Number.isFinite(c)||c<=0))continue;c=c||0;const l=O(c);if(l>.925)continue;const u=(1-l)*(t.args.data.encodedDataLength||0);a.set(t.args.data.requestId,u),s+=u,r.push({request:t,ttl:c,wastedBytes:u})}return r.sort(((e,t)=>t.request.args.data.decodedBodyLength-e.request.args.data.decodedBodyLength||e.ttl-t.ttl)),o={relatedEvents:r.map((e=>e.request)),requests:r,metricSavings:S(a,n),totalWastedBytes:s},{insightKey:"Cache",strings:L,title:P(L.title),description:P(L.description),category:M.ALL,state:o.requests.length>0?"fail":"pass",...o};var o},getCombinedHeaders:D,i18nString:P,isCacheable:R});const A={title:"Layout shift culprits",description:"Layout shifts occur when elements move absent any user interaction. [Investigate the causes of layout shifts](https://web.dev/articles/optimize-cls), such as elements being added, removed, or their fonts changing as the page loads.",worstLayoutShiftCluster:"Worst layout shift cluster",worstCluster:"Worst cluster",layoutShiftCluster:"Layout shift cluster @ {PH1}",topCulprits:"Top layout shift culprits",injectedIframe:"Injected iframe",fontRequest:"Font request",animation:"Animation",unsizedImages:"Unsized Images",noLayoutShifts:"No layout shifts",noCulprits:"Could not detect any layout shift culprits"},F=n.i18n.registerUIStrings("models/trace/insights/CLSCulprits.ts",A),U=n.i18n.getLocalizedString.bind(void 0,F),k=[{flag:1,failure:"ACCELERATED_ANIMATIONS_DISABLED"},{flag:2,failure:"EFFECT_SUPPRESSED_BY_DEVTOOLS"},{flag:4,failure:"INVALID_ANIMATION_OR_EFFECT"},{flag:8,failure:"EFFECT_HAS_UNSUPPORTED_TIMING_PARAMS"},{flag:16,failure:"EFFECT_HAS_NON_REPLACE_COMPOSITE_MODE"},{flag:32,failure:"TARGET_HAS_INVALID_COMPOSITING_STATE"},{flag:64,failure:"TARGET_HAS_INCOMPATIBLE_ANIMATIONS"},{flag:128,failure:"TARGET_HAS_CSS_OFFSET"},{flag:512,failure:"ANIMATION_AFFECTS_NON_CSS_PROPERTIES"},{flag:1024,failure:"TRANSFORM_RELATED_PROPERTY_CANNOT_BE_ACCELERATED_ON_TARGET"},{flag:2048,failure:"TRANSFROM_BOX_SIZE_DEPENDENT"},{flag:4096,failure:"FILTER_RELATED_PROPERTY_MAY_MOVE_PIXELS"},{flag:8192,failure:"UNSUPPORTED_CSS_PROPERTY"},{flag:32768,failure:"MIXED_KEYFRAME_VALUE_TYPES"},{flag:65536,failure:"TIMELINE_SOURCE_HAS_INVALID_COMPOSITING_STATE"},{flag:1<<17,failure:"ANIMATION_HAS_NO_VISIBLE_CHANGE"},{flag:1<<18,failure:"AFFECTS_IMPORTANT_PROPERTY"},{flag:1<<19,failure:"SVG_TARGET_HAS_INDEPENDENT_TRANSFORM_PROPERTY"}],x=e.Timing.secondsToMicro(t.Timing.Seconds(.5));function B(e,t){const n=e.dur?e.ts+e.dur:e.ts;return n<t.ts&&n>=t.ts-x}function H(e){const t=[],n=e.args.data.beginEvent,i=e.args.data.instantEvents||[];for(const r of i){const i=r.args.data.compositeFailed,s=r.args.data.unsupportedProperties;if(!i)continue;const a=k.filter((e=>i&e.flag)).map((e=>e.failure)),o={name:n.args.data.displayName,failureReasons:a,unsupportedProperties:s,animation:e};t.push(o)}return t}function j(e,t){const n=i.ArrayUtilities.nearestIndexFromBeginning(e,(e=>e.ts>t.ts+(t.dur||0)));if(null!==n)return e[n]}function W(e,t){const n=[],i=e.events;for(const e of i){const i=t.get(e);if(!i)continue;const r=i.fontRequests,s=i.iframeIds,a=i.nonCompositedAnimations,o=i.unsizedImages;for(let e=0;e<r.length&&n.length<3;e++)n.push(U(A.fontRequest));for(let e=0;e<s.length&&n.length<3;e++)n.push(U(A.injectedIframe));for(let e=0;e<a.length&&n.length<3;e++)n.push(U(A.animation));for(let e=0;e<o.length&&n.length<3;e++)n.push(U(A.unsizedImages));if(n.length>=3)break}return n.slice(0,3)}var V=Object.freeze({__proto__:null,UIStrings:A,generateInsight:function(n,s){const a=t=>e.Timing.eventIsInBounds(t,s.bounds),o=n.Animations.animations.filter(a),c=n.LayoutShifts.renderFrameImplCreateChildFrameEvents.filter(a),l=n.NetworkRequests.byTime.filter(a),u=n.LayoutShifts.domLoadingEvents.filter(a),d=n.LayoutShifts.layoutImageUnsizedEvents.filter(a),g=s.navigation?s.navigationId:t.Events.NO_NAVIGATION,p=n.LayoutShifts.clustersByNavigationId.get(g)??[],m=p.toSorted(((e,t)=>t.clusterCumulativeScore-e.clusterCumulativeScore)).at(0),f=p.flatMap((e=>e.events)),h=n.LayoutShifts.prePaintEvents.filter(a),v=n.LayoutShifts.paintImageEvents.filter(a),y=new Map,S=function(e,t){const n=new Map;for(const r of t){const t=i.ArrayUtilities.nearestIndexFromBeginning(e,(e=>e.ts>=r.ts));if(null!==t)for(let s=t;s<e.length;s++){const t=e[s];if(t.ts>=r.ts&&t.ts<=r.ts+r.dur&&i.MapUtilities.getWithDefault(n,r,(()=>[])).push(t),t.ts>r.ts+r.dur)break}}return n}(f,h);for(const e of f)y.set(e,{iframeIds:[],fontRequests:[],nonCompositedAnimations:[],unsizedImages:[]});!function(e,n,i,r,s){for(const a of e){const e=j(n,a);if(!e)continue;const o=i.get(e);if(o)for(const e of o){const n=r.get(e);if(!n)throw new Error("Unaccounted shift");const i=s.find((e=>{const n=t.Timing.Micro(a.ts+(a.dur??0));return e.ts>=a.ts&&e.ts<=n}));i?.args.frame&&n.iframeIds.push(i.args.frame)}}}(c,h,S,y,u),function(e,t,n,i){const r=e.filter((e=>"Font"===e.args.data.resourceType&&e.args.data.mimeType.startsWith("font")));for(const e of r){const r=j(t,e);if(!r)continue;if(!B(e,r))continue;const s=n.get(r);if(s)for(const t of s){const n=i.get(t);if(!n)throw new Error("Unaccounted shift");n.fontRequests.push(e)}}}(l,h,S,y),function(e,t,n,i){n.forEach(((n,r)=>{const s=j(t,r),a=e.find((e=>e.args.data.nodeId===s?.args.data.nodeId));if(a)for(const e of n){const t=i.get(e);if(!t)throw new Error("Unaccounted shift");t.unsizedImages.push(a.args.data.nodeId)}}))}(d,v,S,y);const T=function(e,t,n,i){const r=[];for(const s of e){const e=H(s);if(!e)continue;r.push(...e);const a=j(t,s);if(!a)continue;if(!B(s,a))continue;const o=n.get(a);if(o)for(const t of o){const n=i.get(t);if(!n)throw new Error("Unaccounted shift");n.nonCompositedAnimations.push(...e)}}return r}(o,h,S,y),I=[...f];m&&I.push(m);const _=new Map;for(const e of p)_.set(e,W(e,y));return function(e){let t="pass";e.worstCluster&&(t="good"===r.ModelHandlers.LayoutShifts.scoreClassificationForLayoutShift(e.worstCluster.clusterCumulativeScore)?"informative":"fail");return{insightKey:"CLSCulprits",strings:A,title:U(A.title),description:U(A.description),category:M.CLS,state:t,...e}}({relatedEvents:I,animationFailures:T,shifts:y,clusters:p,worstCluster:m,topCulpritsByCluster:_})},getNonCompositedFailure:H,i18nString:U});const K={title:"Document request latency",description:"Your first network request is the most important.  Reduce its latency by avoiding redirects, ensuring a fast server response, and enabling text compression.",passingRedirects:"Avoids redirects",failedRedirects:"Had redirects",passingServerResponseTime:"Server responds quickly",failedServerResponseTime:"Server responded slowly",passingTextCompression:"Applies text compression",failedTextCompression:"No compression applied",redirectsLabel:"Redirects",serverResponseTimeLabel:"Server response time",uncompressedDownload:"Uncompressed download"},G=n.i18n.registerUIStrings("models/trace/insights/DocumentLatency.ts",K),J=n.i18n.getLocalizedString.bind(void 0,G);function $(e){let t=!1;return e.data&&(t=!e.data.checklist.usesCompression.value||!e.data.checklist.serverResponseIsFast.value||!e.data.checklist.noRedirects.value),{insightKey:"DocumentLatency",strings:K,title:J(K.title),description:J(K.description),category:M.ALL,state:t?"fail":"pass",...e}}var Y=Object.freeze({__proto__:null,UIStrings:K,generateInsight:function(n,i){if(!i.navigation)return $({});const r=n.NetworkRequests.byTime.find((e=>e.args.data.requestId===i.navigationId));if(!r)return $({warnings:[E.NO_DOCUMENT_REQUEST]});const s=function(t){if(!t.args.data.timing)return null;const n=e.Timing.microToMilli(t.args.data.syntheticData.waiting);return Math.round(n)}(r);if(null===s)throw new Error("missing document request timing");const a=s>600;let o=0;s>600&&(o=Math.max(s-100,0));const c=Math.round(r.args.data.syntheticData.redirectionDuration/1e3);o+=c;const l={FCP:o,LCP:o},u=function(e){if(T(e))return 0;const t=e.args.data.decodedBodyLength;let n=0;switch(e.args.data.mimeType){case"text/css":n=Math.round(.8*t);break;case"text/html":case"text/javascript":n=Math.round(.67*t);break;case"text/plain":case"text/xml":case"text/x-component":case"application/javascript":case"application/json":case"application/manifest+json":case"application/vnd.api+json":case"application/xml":case"application/xhtml+xml":case"application/rss+xml":case"application/atom+xml":case"application/vnd.ms-fontobject":case"application/x-font-ttf":case"application/x-font-opentype":case"application/x-font-truetype":case"image/svg+xml":case"image/x-icon":case"image/vnd.microsoft.icon":case"font/ttf":case"font/eot":case"font/otf":case"font/opentype":n=Math.round(.5*t)}return n<1400?0:n}(r),d=0===c,g=!a,p=0===u;return $({relatedEvents:[r],data:{serverResponseTime:s,redirectDuration:t.Timing.Milli(c),uncompressedResponseBytes:u,documentRequest:r,checklist:{noRedirects:{label:J(d?K.passingRedirects:K.failedRedirects),value:d},serverResponseIsFast:{label:J(g?K.passingServerResponseTime:K.failedServerResponseTime),value:g},usesCompression:{label:J(p?K.passingTextCompression:K.failedTextCompression),value:p}}},metricSavings:l})},i18nString:J,isDocumentLatency:function(e){return"DocumentLatency"===e.insightKey}});const Z={title:"Optimize DOM size",description:"A large DOM can increase the duration of style calculations and layout reflows, impacting page responsiveness. A large DOM will also increase memory usage. [Learn how to avoid an excessive DOM size](https://developer.chrome.com/docs/lighthouse/performance/dom-size/).",statistic:"Statistic",value:"Value",element:"Element",totalElements:"Total elements",maxDOMDepth:"DOM depth",maxChildren:"Most children"},Q=n.i18n.registerUIStrings("models/trace/insights/DOMSize.ts",Z),X=n.i18n.getLocalizedString.bind(void 0,Q),ee=e.Timing.milliToMicro(t.Timing.Milli(40));var te=Object.freeze({__proto__:null,UIStrings:Z,generateInsight:function(n,i){const s=t=>e.Timing.eventIsInBounds(t,i.bounds),a=i.navigation?.tid,o=[],c=[],l=r.Threads.threadsInRenderer(n.Renderer,n.AuctionWorklets);for(const r of l){if("MAIN_THREAD"!==r.type)continue;if(void 0===a){if(!r.processIsOnMainFrame)continue}else if(r.tid!==a)continue;const l=n.Renderer.processes.get(r.pid)?.threads.get(r.tid);if(!l)continue;const{entries:u,layoutEvents:d,updateLayoutTreeEvents:g}=l;if(!u.length)continue;const p=u[0],m=u[u.length-1],f=e.Timing.traceWindowFromMicroSeconds(p.ts,t.Timing.Micro(m.ts+(m.dur??0)));if(e.Timing.boundsIncludeTimeRange({timeRange:f,bounds:i.bounds})){for(const e of d){if(e.dur<ee||!s(e))continue;const{dirtyObjects:t}=e.args.beginData;t>100&&o.push(e)}for(const e of g){if(e.dur<ee||!s(e))continue;const{elementCount:t}=e.args;t>300&&c.push(e)}}}const u=n.DOMStats.domStatsByFrameId.get(i.frameId)?.filter(s)??[];let d;for(const e of u){const t=i.navigation?.pid;t&&e.pid!==t||(!d||e.args.data.totalElements>d.args.data.totalElements)&&(d=e)}return function(e){const t=[...e.largeLayoutUpdates,...e.largeStyleRecalcs];return{insightKey:"DOMSize",strings:Z,title:X(Z.title),description:X(Z.description),category:M.INP,state:t.length>0?"fail":"pass",...e,relatedEvents:t}}({largeLayoutUpdates:o,largeStyleRecalcs:c,maxDOMStats:d})},i18nString:X});const ne={title:"Duplicated JavaScript",description:"Remove large, duplicate JavaScript modules from bundles to reduce unnecessary bytes consumed by network activity.",columnSource:"Source",columnDuplicatedBytes:"Duplicated bytes"},ie=n.i18n.registerUIStrings("models/trace/insights/DuplicatedJavaScript.ts",ne),re=n.i18n.getLocalizedString.bind(void 0,ie);var se=Object.freeze({__proto__:null,UIStrings:ne,generateInsight:function(t,n){const i=t.Scripts.scripts.filter((t=>!!n.navigation&&(t.frame===n.frameId&&(!t.url?.startsWith("chrome-extension://")&&e.Timing.timestampIsInBounds(n.bounds,t.ts))))),{duplication:r,duplicationGroupedByNodeModules:a}=s.ScriptDuplication.computeScriptDuplication({scripts:i}),o=[...r.values().flatMap((e=>e.duplicates.map((e=>e.script))))],c=new Map;for(const{duplicates:e}of r.values())for(let t=1;t<e.length;t++){const n=e[t];if(!n.script.request)continue;const i=_(n.script),r=Math.round(n.attributedSize*i),s=n.script.request.args.data.requestId;c.set(s,(c.get(s)||0)+r)}return function(e){const t=e.scriptsWithDuplication.map((e=>e.request)).filter((e=>!!e));return{insightKey:"DuplicatedJavaScript",strings:ne,title:re(ne.title),description:re(ne.description),category:M.LCP,state:Boolean(e.duplication.values().next().value)?"fail":"pass",relatedEvents:[...new Set(t)],...e}}({duplication:r,duplicationGroupedByNodeModules:a,scriptsWithDuplication:[...new Set(o)],scripts:i,mainDocumentUrl:n.navigation?.args.data?.url??t.Meta.mainFrameURL,metricSavings:S(c,n)})},i18nString:re});const ae={title:"Font display",description:"Consider setting [`font-display`](https://developer.chrome.com/blog/font-display) to `swap` or `optional` to ensure text is consistently visible. `swap` can be further optimized to mitigate layout shifts with [font metric overrides](https://developer.chrome.com/blog/font-fallbacks).",fontColumn:"Font",wastedTimeColumn:"Wasted time"},oe=n.i18n.registerUIStrings("models/trace/insights/FontDisplay.ts",ae),ce=n.i18n.getLocalizedString.bind(void 0,oe);var le=Object.freeze({__proto__:null,UIStrings:ae,generateInsight:function(n,r){const s=[];for(const a of n.LayoutShifts.remoteFonts){const o=a.beginRemoteFontLoadEvent;if(!e.Timing.eventIsInBounds(o,r.bounds))continue;const c=`${o.pid}.${o.args.id}`,l=n.NetworkRequests.byId.get(c);if(!l)continue;if(!/^(block|fallback|auto)$/.test(a.display))continue;const u=t.Timing.Micro(l.args.data.syntheticData.finishTime-l.args.data.syntheticData.sendStartTime);let d=i.NumberUtilities.floor(e.Timing.microToMilli(u),.2);0!==d&&(d=Math.min(d,3e3),s.push({name:a.name,request:l,display:a.display,wastedTime:d}))}s.sort(((e,t)=>t.wastedTime-e.wastedTime));const a=Math.max(...s.map((e=>e.wastedTime)));return o={relatedEvents:s.map((e=>e.request)),fonts:s,metricSavings:{FCP:a}},{insightKey:"FontDisplay",strings:ae,title:ce(ae.title),description:ce(ae.description),category:M.INP,state:o.fonts.find((e=>e.wastedTime>0))?"fail":"pass",...o};var o},i18nString:ce});const ue={title:"Forced reflow",description:"Many APIs, typically reading layout geometry, force the rendering engine to pause script execution in order to calculate the style and layout. Learn more about [forced reflow](https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid-forced-synchronous-layouts) and its mitigations.",relatedStackTrace:"Stack trace",topTimeConsumingFunctionCall:"Top function call",totalReflowTime:"Total reflow time",unattributed:"Unattributed"},de=n.i18n.registerUIStrings("models/trace/insights/ForcedReflow.ts",ue),ge=n.i18n.getLocalizedString.bind(void 0,de);function pe(e){return e.scriptId+":"+e.lineNumber+":"+e.columnNumber}function me(t,n){const i=s.StackTraceForEvent.get(t,n),r=e.Trace.getZeroIndexedStackTraceForEvent(t);return i?.callFrames[0]??r?.[0]??null}var fe=Object.freeze({__proto__:null,UIStrings:ue,generateInsight:function(n,r){const s=new Map,a=n.Warnings.perWarning.get("FORCED_REFLOW")?.filter((t=>e.Trace.frameIDForEvent(t)===r.frameId&&e.Timing.eventIsInBounds(t,r.bounds)))??[];for(const e of a){const t=me(e,n),r=t?pe(t):"UNATTRIBUTED",a=i.MapUtilities.getWithDefault(s,r,(()=>({bottomUpData:t,totalTime:0,relatedEvents:[]})));a.totalTime+=e.dur??0,a.relatedEvents.push(e)}const o=function(e,n){const r=n.Renderer.entryToNode,s=new Map;if(0===e.length)return;for(const n of e){const e=r.get(n);if(!e)continue;let a,o,c=e.parent;for(;c;){const e=c.entry;if(!t.Events.isProfileCall(e)){t.Events.isFunctionCall(e)&&e.args.data&&t.Events.objectIsCallFrame(e.args.data)&&(a=e.args.data,o=e);break}a=e.callFrame,o=e,c=c.parent}if(!a||!o)continue;const l=pe(a),u=i.MapUtilities.getWithDefault(s,l,(()=>({topLevelFunctionCall:a,totalReflowTime:0,topLevelFunctionCallEvents:[]})));u.totalReflowTime+=n.dur??0,u.topLevelFunctionCallEvents.push(o)}let a;return s.forEach((e=>{(!a||e.totalReflowTime>a.totalReflowTime)&&(a=e)})),a}(a,n);return c={relatedEvents:a,topLevelFunctionCallData:o,aggregatedBottomUpData:[...s.values()]},{insightKey:"ForcedReflow",strings:ue,title:ge(ue.title),description:ge(ue.description),category:M.ALL,state:0!==c.aggregatedBottomUpData.length?"fail":"pass",...c};var c},i18nString:ge});const he={title:"Improve image delivery",description:"Reducing the download time of images can improve the perceived load time of the page and LCP. [Learn more about optimizing image size](https://developer.chrome.com/docs/lighthouse/performance/uses-optimized-images/)",useCompression:"Increasing the image compression factor could improve this image's download size.",useModernFormat:"Using a modern image format (WebP, AVIF) or increasing the image compression could improve this image's download size.",useVideoFormat:"Using video formats instead of GIFs can improve the download size of animated content.",useResponsiveSize:"This image file is larger than it needs to be ({PH1}) for its displayed dimensions ({PH2}). Use responsive images to reduce the image download size.",optimizeFile:"Optimize file size",others:"{PH1} others",noOptimizableImages:"No optimizable images",estimatedSavings:"{PH1} (Est {PH2})"},ve=n.i18n.registerUIStrings("models/trace/insights/ImageDelivery.ts",he),ye=n.i18n.getLocalizedString.bind(void 0,ve),Se=2/12;var Te;function Ie(e){switch(e.type){case Te.ADJUST_COMPRESSION:return ye(he.useCompression);case Te.MODERN_FORMAT_OR_COMPRESSION:return ye(he.useModernFormat);case Te.VIDEO_FORMAT:return ye(he.useVideoFormat);case Te.RESPONSIVE_SIZE:return ye(he.useResponsiveSize,{PH1:`${e.fileDimensions.width}x${e.fileDimensions.height}`,PH2:`${e.displayDimensions.width}x${e.displayDimensions.height}`})}}function _e(e){const t=n.ByteUtilities.bytesToString(e.byteSavings),i=Ie(e);return ye(he.estimatedSavings,{PH1:i,PH2:t})}function Ee(e){return Math.round(29.1*Math.log10(e.args.data.decodedBodyLength)-100.7)/100}function Me(e){return{filePixels:e.args.data.srcWidth*e.args.data.srcHeight,displayedPixels:e.args.data.width*e.args.data.height}}!function(e){e.ADJUST_COMPRESSION="ADJUST_COMPRESSION",e.MODERN_FORMAT_OR_COMPRESSION="MODERN_FORMAT_OR_COMPRESSION",e.VIDEO_FORMAT="VIDEO_FORMAT",e.RESPONSIVE_SIZE="RESPONSIVE_SIZE"}(Te||(Te={}));var we=Object.freeze({__proto__:null,get ImageOptimizationType(){return Te},UIStrings:he,generateInsight:function(t,n){const i=t=>e.Timing.eventIsInBounds(t,n.bounds),r=t.NetworkRequests.byTime.filter(i),s=[];for(const e of r){if("Image"!==e.args.data.resourceType)continue;if("image/svg+xml"===e.args.data.mimeType)continue;const n=e.args.data.redirects[0]?.url??e.args.data.url,r=t.ImagePainting.paintImageEventForUrl.get(n)?.filter(i);if(!r?.length)continue;const a=r.reduce(((e,t)=>Me(e).displayedPixels>Me(t).displayedPixels?e:t)),{filePixels:o,displayedPixels:c}=Me(a),l=Math.min(e.args.data.decodedBodyLength,e.args.data.encodedDataLength),u=l/o;let d=[];if("image/gif"===e.args.data.mimeType){if(l>102400){const t=Ee(e),n=Math.round(l*t);d.push({type:Te.VIDEO_FORMAT,byteSavings:n})}}else if(u>Se){const t=l-Math.round(Se*o);"image/webp"!==e.args.data.mimeType&&"image/avif"!==e.args.data.mimeType?d.push({type:Te.MODERN_FORMAT_OR_COMPRESSION,byteSavings:t}):d.push({type:Te.ADJUST_COMPRESSION,byteSavings:t})}const g=Math.max(0,...d.map((e=>e.byteSavings)));let p=g;const m=1-c/o;if(m>0&&!a.args.data.isCSS){const e=Math.round(m*l);(!(a.args.data.isPicture||a.args.data.srcsetAttribute)||e>12288)&&(p+=Math.round(m*(l-g)),d.push({type:Te.RESPONSIVE_SIZE,byteSavings:e,fileDimensions:{width:Math.round(a.args.data.srcWidth),height:Math.round(a.args.data.srcHeight)},displayDimensions:{width:Math.round(a.args.data.width),height:Math.round(a.args.data.height)}}))}d=d.filter((e=>e.byteSavings>4096)),d.length>0&&s.push({request:e,largestImagePaint:a,optimizations:d,byteSavings:p})}const a=new Map;for(const e of s)a.set(e.request.args.data.requestId,e.byteSavings);return s.sort(((e,t)=>t.byteSavings!==e.byteSavings?t.byteSavings-e.byteSavings:t.request.args.data.decodedBodyLength-e.request.args.data.decodedBodyLength)),o={optimizableImages:s,totalByteSavings:s.reduce(((e,t)=>e+t.byteSavings),0),metricSavings:S(a,n)},{insightKey:"ImageDelivery",strings:he,title:ye(he.title),description:ye(he.description),category:M.LCP,state:o.optimizableImages.length>0?"fail":"pass",...o,relatedEvents:new Map(o.optimizableImages.map((e=>[e.request,e.optimizations.map(_e)])))};var o},getOptimizationMessage:Ie,getOptimizationMessageWithBytes:_e,i18nString:ye});const be={description:"Start investigating with the longest phase. [Delays can be minimized](https://web.dev/articles/optimize-inp#optimize_interactions). To reduce processing duration, [optimize the main-thread costs](https://web.dev/articles/optimize-long-tasks), often JS.",title:"INP by phase",phase:"Phase",duration:"Duration",inputDelay:"Input delay",processingDuration:"Processing duration",presentationDelay:"Presentation delay",noInteractions:"No interactions detected"},Le=n.i18n.registerUIStrings("models/trace/insights/InteractionToNextPaint.ts",be),Ce=n.i18n.getLocalizedString.bind(void 0,Le);function Pe(e){return{insightKey:"InteractionToNextPaint",strings:be,title:Ce(be.title),description:Ce(be.description),category:M.INP,state:e.longestInteractionEvent?"informative":"pass",...e}}var Re=Object.freeze({__proto__:null,UIStrings:be,generateInsight:function(t,n){const i=t.UserInteractions.interactionEventsWithNoNesting.filter((t=>e.Timing.eventIsInBounds(t,n.bounds)));if(!i.length)return Pe({});const r=new Map;for(const e of i){const t=e.interactionId,n=r.get(t);(!n||e.dur>n.dur)&&r.set(t,e)}const s=[...r.values()];s.sort(((e,t)=>t.dur-e.dur));const a=Math.min(9,Math.floor(s.length/50));return Pe({relatedEvents:[s[0]],longestInteractionEvent:s[0],highPercentileInteractionEvent:s[a]})},i18nString:Ce,isINP:function(e){return"InteractionToNextPaint"===e.insightKey}});const Ne={title:"LCP request discovery",description:"Optimize LCP by making the LCP image [discoverable](https://web.dev/articles/optimize-lcp#1_eliminate_resource_load_delay) from the HTML immediately, and [avoiding lazy-loading](https://web.dev/articles/lcp-lazy-loading)",lcpLoadDelay:"LCP image loaded {PH1} after earliest start point.",fetchPriorityApplied:"fetchpriority=high applied",fetchPriorityShouldBeApplied:"fetchpriority=high should be applied",requestDiscoverable:"Request is discoverable in initial document",lazyLoadNotApplied:"lazy load not applied",noLcp:"No LCP detected",noLcpResource:"No LCP resource detected because the LCP is not an image"},Oe=n.i18n.registerUIStrings("models/trace/insights/LCPDiscovery.ts",Ne),De=n.i18n.getLocalizedString.bind(void 0,Oe);function qe(e){const t=e.lcpEvent&&e.lcpRequest?[e.lcpEvent,e.lcpRequest]:[];return{insightKey:"LCPDiscovery",strings:Ne,title:De(Ne.title),description:De(Ne.description),category:M.LCP,state:!e.lcpRequest||!e.checklist||e.checklist.eagerlyLoaded.value&&e.checklist.requestDiscoverable.value&&e.checklist.priorityHinted.value?"pass":"fail",...e,relatedEvents:t}}var ze=Object.freeze({__proto__:null,UIStrings:Ne,generateInsight:function(n,i){if(!i.navigation)return qe({});const r=n.NetworkRequests,s=n.PageLoadMetrics.metricScoresByFrameId.get(i.frameId);if(!s)throw new Error("no frame metrics");const a=s.get(i.navigationId);if(!a)throw new Error("no navigation metrics");const o=a.get("LCP"),c=o?.event;if(!c||!t.Events.isLargestContentfulPaintCandidate(c))return qe({warnings:[E.NO_LCP]});const l=r.byTime.find((e=>e.args.data.requestId===i.navigationId));if(!l)return qe({warnings:[E.NO_DOCUMENT_REQUEST]});const u=n.LargestImagePaint.lcpRequestByNavigationId.get(i.navigationId);if(!u)return qe({lcpEvent:c});const d=u.args.data.initiator?.url,g="parser"===u?.args.data.initiator?.type&&l.args.data.url===d,p=u?.args.data.isLinkPreload||g,m=c.args.data?.loadingAttr,f=u?.args.data.fetchPriorityHint,h=l?.args.data.timing?e.Timing.secondsToMicro(l.args.data.timing.requestTime)+e.Timing.milliToMicro(l.args.data.timing.receiveHeadersStart):void 0,v="high"===f;return qe({lcpEvent:c,lcpRequest:u,earliestDiscoveryTimeTs:h?t.Timing.Micro(h):void 0,checklist:{priorityHinted:{label:De(v?Ne.fetchPriorityApplied:Ne.fetchPriorityShouldBeApplied),value:v},requestDiscoverable:{label:De(Ne.requestDiscoverable),value:p},eagerlyLoaded:{label:De(Ne.lazyLoadNotApplied),value:"lazy"!==m}}})},i18nString:De,isLCPDiscovery:function(e){return"LCPDiscovery"===e.insightKey}});const Ae={title:"LCP by phase",description:"Each [phase has specific improvement strategies](https://web.dev/articles/optimize-lcp#lcp-breakdown). Ideally, most of the LCP time should be spent on loading the resources, not within delays.",timeToFirstByte:"Time to first byte",resourceLoadDelay:"Resource load delay",resourceLoadDuration:"Resource load duration",elementRenderDelay:"Element render delay",phase:"Phase",duration:"Duration",fieldDuration:"Field 75th percentile",noLcp:"No LCP detected"},Fe=n.i18n.registerUIStrings("models/trace/insights/LCPPhases.ts",Ae),Ue=n.i18n.getLocalizedString.bind(void 0,Fe);function ke(...e){return e.some((e=>Number.isNaN(e)))}function xe(n,i,r,s){const a=i.args.data.timing;if(!a)throw new Error("no timing for document request");const o=e.Timing.secondsToMicro(a.requestTime)+e.Timing.milliToMicro(a.receiveHeadersStart),c=t.Timing.Micro(o-n.ts),l=e.Timing.microToMilli(c);let u=t.Timing.Milli(r-l);if(!s)return ke(l,u)?null:{ttfb:l,renderDelay:u};const d=t.Timing.Micro(s.ts-n.ts),g=e.Timing.microToMilli(d),p=t.Timing.Micro(s.args.data.syntheticData.finishTime-n.ts),m=e.Timing.microToMilli(p),f=t.Timing.Milli(g-l),h=t.Timing.Milli(m-g);return u=t.Timing.Milli(r-m),ke(l,f,h,u)?null:{ttfb:l,loadDelay:f,loadTime:h,renderDelay:u}}function Be(e){const t=[];return e.lcpEvent&&t.push(e.lcpEvent),e.lcpRequest&&t.push(e.lcpRequest),{insightKey:"LCPPhases",strings:Ae,title:Ue(Ae.title),description:Ue(Ae.description),category:M.LCP,state:e.lcpEvent||e.lcpRequest?"informative":"pass",...e,relatedEvents:t}}var He=Object.freeze({__proto__:null,UIStrings:Ae,generateInsight:function(n,i){if(!i.navigation)return Be({});const r=n.NetworkRequests,s=n.PageLoadMetrics.metricScoresByFrameId.get(i.frameId);if(!s)throw new Error("no frame metrics");const a=s.get(i.navigationId);if(!a)throw new Error("no navigation metrics");const o=a.get("LCP"),c=o?.event;if(!c||!t.Events.isLargestContentfulPaintCandidate(c))return Be({warnings:[E.NO_LCP]});const l=e.Timing.microToMilli(o.timing),u=o.event?.ts?e.Timing.microToMilli(o.event?.ts):void 0,d=n.LargestImagePaint.lcpRequestByNavigationId.get(i.navigationId),g=r.byTime.find((e=>e.args.data.requestId===i.navigationId));return Be(g?{lcpMs:l,lcpTs:u,lcpEvent:c,lcpRequest:d,phases:xe(i.navigation,g,l,d)??void 0}:{lcpMs:l,lcpTs:u,lcpEvent:c,lcpRequest:d,warnings:[E.NO_DOCUMENT_REQUEST]})},i18nString:Ue,isLCPPhases:function(e){return"LCPPhases"===e.insightKey}});const{detectLegacyJavaScript:je}=a.LegacyJavaScript,We={title:"Legacy JavaScript",description:"Polyfills and transforms enable legacy browsers to use new JavaScript features. However, many aren't necessary for modern browsers. Consider modifying your JavaScript build process to not transpile [Baseline](https://web.dev/articles/baseline-and-polyfills) features, unless you know you must support legacy browsers. [Learn why most sites can deploy ES6+ code without transpiling](https://philipwalton.com/articles/the-state-of-es5-on-the-web/)",columnScript:"Script",columnWastedBytes:"Wasted bytes"},Ve=n.i18n.registerUIStrings("models/trace/insights/LegacyJavaScript.ts",We),Ke=n.i18n.getLocalizedString.bind(void 0,Ve);var Ge=Object.freeze({__proto__:null,UIStrings:We,generateInsight:function(t,n){const i=t.Scripts.scripts.filter((t=>!!n.navigation&&(t.frame===n.frameId&&(!t.url?.startsWith("chrome-extension://")&&e.Timing.timestampIsInBounds(n.bounds,t.ts))))),r=new Map,s=new Map;for(const e of i){if(!e.content||e.content.length<5e3)continue;const t=je(e.content,e.sourceMap);if(!(t.estimatedByteSavings<5e3)&&(r.set(e,t),e.request)){const n=_(e),i=Math.round(t.estimatedByteSavings*n),r=e.request.args.data.requestId;s.set(r,i)}}return function(e){const t=[...e.legacyJavaScriptResults.keys()].map((e=>e.request)).filter((e=>!!e));return{insightKey:"LegacyJavaScript",strings:We,title:Ke(We.title),description:Ke(We.description),category:M.ALL,state:t.length?"fail":"pass",relatedEvents:[...new Set(t)],...e}}({legacyJavaScriptResults:new Map([...r].sort(((e,t)=>t[1].estimatedByteSavings-e[1].estimatedByteSavings))),metricSavings:S(s,n)})},i18nString:Ke});const Je={title:"Modern HTTP",description:"HTTP/2 and HTTP/3 offer many benefits over HTTP/1.1, such as multiplexing. [Learn more about using modern HTTP](https://developer.chrome.com/docs/lighthouse/best-practices/uses-http2/).",request:"Request",protocol:"Protocol",noOldProtocolRequests:"No requests used HTTP/1.1"},$e=n.i18n.registerUIStrings("models/trace/insights/ModernHTTP.ts",Je),Ye=n.i18n.getLocalizedString.bind(void 0,$e);function Ze(t,n,i){if(!e.Network.STATIC_RESOURCE_TYPES.has(t.args.data.resourceType))return!1;if(t.args.data.decodedBodyLength<100){const e=n.entityByEvent.get(t);if(e){if(i?.name===e.name)return!0;if(!e.isUnrecognized)return!1}}return!0}function Qe(t,n,r){const s=[],a=new Map;for(const s of t){const t=new URL(s.args.data.url);if(!Ze(s,n,r))continue;if(e.Network.isSyntheticNetworkRequestLocalhost(s))continue;i.MapUtilities.getWithDefault(a,t.origin,(()=>[])).push(s)}const o=new Set;for(const e of t){if(o.has(e.args.data.url))continue;if(e.args.data.fromServiceWorker)continue;if(!/HTTP\/[01][.\d]?/i.test(e.args.data.protocol))continue;const t=new URL(e.args.data.url);(a.get(t.origin)||[]).length<6||(o.add(e.args.data.url),s.push(e))}return s}function Xe(e,t,n){const r=n.simulate(t),s=new Map;t.traverse((t=>{"network"===t.type&&e.has(t.request.url)&&(s.set(t.request.requestId,t.request.protocol),t.request.protocol="h2")}));const a=n.simulate(t);t.traverse((e=>{if("network"!==e.type)return;const t=s.get(e.request.requestId);void 0!==t&&(e.request.protocol=t)}));const o=r.timeInMs-a.timeInMs;return i.NumberUtilities.floor(o,.1)}function et(e,t){if(!t.navigation||!t.lantern)return;const n=new Set(e.map((e=>e.args.data.url))),i=t.lantern.metrics.firstContentfulPaint.optimisticGraph,r=t.lantern.metrics.largestContentfulPaint.optimisticGraph;return{FCP:Xe(n,i,t.lantern.simulator),LCP:Xe(n,r,t.lantern.simulator)}}var tt=Object.freeze({__proto__:null,UIStrings:Je,determineNonHttp2Resources:Qe,generateInsight:function(t,n){const i=t.NetworkRequests.byTime.filter((t=>e.Timing.eventIsInBounds(t,n.bounds))),s=t.NetworkRequests.entityMappings,a=n.navigation?.args.data?.documentLoaderURL??t.Meta.mainFrameURL,o=Qe(i,s,r.Helpers.getEntityForUrl(a,s.createdEntityCache)??null);return c={requests:o,metricSavings:et(o,n)},{insightKey:"ImageDelivery",strings:Je,title:Ye(Je.title),description:Ye(Je.description),category:M.LCP,state:c.requests.length>0?"fail":"pass",...c,relatedEvents:c.requests};var c},i18nString:Ye});const nt={title:"Network dependency tree",description:"[Avoid chaining critical requests](https://developer.chrome.com/docs/lighthouse/performance/critical-request-chains) by reducing the length of chains, reducing the download size of resources, or deferring the download of unnecessary resources to improve page load.",warningDescription:"Avoid chaining critical requests by reducing the length of chains, reducing the download size of resources, or deferring the download of unnecessary resources to improve page load.",noNetworkDependencyTree:"No rendering tasks impacted by network dependencies",maxCriticalPathLatency:"Max critical path latency:"},it=n.i18n.registerUIStrings("models/trace/insights/NetworkDependencyTree.ts",nt),rt=n.i18n.getLocalizedString.bind(void 0,it),st=new Set(["Image","XHR","Fetch","EventSource"]);function at(e){return{insightKey:"NetworkDependencyTree",strings:nt,title:rt(nt.title),description:rt(nt.description),category:M.LCP,state:e.fail?"fail":"pass",...e}}function ot(t,n){if(t.args.data.requestId===n.navigationId)return!0;if(t.args.data.isLinkPreload)return!1;const i="Document"===t.args.data.resourceType&&t.args.data.frame!==n.frameId;if(st.has(t.args.data.resourceType)||i||t.args.data.mimeType.startsWith("image/"))return!1;if(!(t.args.data.initiator?.url||e.Trace.getZeroIndexedStackTraceForEvent(t)?.at(0)?.url))return!1;const r=e.Network.isSyntheticNetworkRequestEventRenderBlocking(t);return e.Network.isSyntheticNetworkRequestHighPriority(t)||r}var ct=Object.freeze({__proto__:null,UIStrings:nt,generateInsight:function(e,n){if(!n.navigation)return at({rootNodes:[],maxTime:t.Timing.Micro(0),fail:!1});const i=[],r=new Map;let s=t.Timing.Micro(0),a=!1,o=[];const c=new Set;if(n.lantern?.graph.traverse(((e,l)=>{if(c.add(e),"network"!==e.type)return;if(!ot(e.rawRequest,n))return;const u=l.filter((e=>"network"===e.type)).reverse().map((e=>e.rawRequest));u.some((e=>!ot(e,n)))||e.isNonNetworkProtocol||function(e){if(0===e.length)return;e.length>=2&&(a=!0);const n=e[0],c=e[e.length-1],l=t.Timing.Micro(c.ts+c.dur-n.ts);l>s&&(s=l,o=e);let u=i;for(let i=0;i<e.length;++i){const s=e[i];let a=u.find((e=>e.request===s));if(!a){const e=t.Timing.Micro(s.ts+s.dur-n.ts);a={request:s,timeFromInitialRequest:e,children:[],relatedRequests:new Set},u.push(a)}e.forEach((e=>a?.relatedRequests.add(e))),r.set(s,i<2?[]:[rt(nt.warningDescription)]),u=a.children}}(u)}),(function(e){return e.getDependents().filter((e=>e.getDependencies().every((e=>c.has(e)))))})),o.length>0){let e=i;for(const t of o){const n=e.find((e=>e.request===t));n?(n.isLongest=!0,e=n.children):console.error("Some request in the longest chain is not found")}}return at({rootNodes:i,maxTime:s,fail:a,relatedEvents:r})},i18nString:rt});const lt={title:"Render blocking requests",description:"Requests are blocking the page's initial render, which may delay LCP. [Deferring or inlining](https://web.dev/learn/performance/understanding-the-critical-path#render-blocking_resources/) can move these network requests out of the critical path.",renderBlockingRequest:"Request",duration:"Duration",noRenderBlocking:"No render blocking requests for this navigation"},ut=n.i18n.registerUIStrings("models/trace/insights/RenderBlocking.ts",lt),dt=n.i18n.getLocalizedString.bind(void 0,ut);function gt(e,t,n){if(!t.lantern)return;const i=function(e){const t=new Map;for(const[n,i]of e)"network"===n.type&&t.set(n.request.requestId,{node:n,nodeTiming:i});return t}(t.lantern.metrics.firstContentfulPaint.optimisticEstimate.nodeTimings),r={FCP:0,LCP:0},s=new Map,a=new Set;for(const e of n){const t=i.get(e.args.data.requestId);if(!t)continue;const{node:n,nodeTiming:r}=t;n.traverse((e=>a.add(e.id)));const o=Math.round(r.duration);o<50||s.set(n.id,o)}return s.size&&(r.FCP=function(e,t){const n=t.simulator,i=t.metrics.firstContentfulPaint.optimisticGraph,{nodeTimings:r}=t.simulator.simulate(i),s=new Map(r),a=i.cloneWithRelationships((t=>!e.has(t.id)));if("network"!==a.type)throw new Error("minimalFCPGraph not a NetworkNode");const o=Math.max(...Array.from(Array.from(s).map((e=>e[1].endTime)))),c=a.request.transferSize,l=c||0;a.request.transferSize=l+0;const u=n.simulate(a).timeInMs;return a.request.transferSize=c,Math.round(Math.max(o-u,0))}(a,t.lantern),function(e,t){return e.LargestImagePaint.lcpRequestByNavigationId.has(t.navigationId)}(e,t)||(r.LCP=r.FCP)),{metricSavings:r,requestIdToWastedMs:s}}function pt(e){return{insightKey:"RenderBlocking",strings:lt,title:dt(lt.title),description:dt(lt.description),category:M.LCP,state:e.renderBlockingRequests.length>0?"fail":"pass",...e}}var mt=Object.freeze({__proto__:null,UIStrings:lt,generateInsight:function(t,n){if(!n.navigation)return pt({renderBlockingRequests:[]});const i=t.PageLoadMetrics.metricScoresByFrameId.get(n.frameId)?.get(n.navigationId)?.get("FP")?.event?.ts;if(!i)return pt({renderBlockingRequests:[],warnings:[E.NO_FP]});let r=[];for(const s of t.NetworkRequests.byTime){if(s.args.data.frame!==n.frameId)continue;if(!e.Network.isSyntheticNetworkRequestEventRenderBlocking(s))continue;if(s.args.data.syntheticData.finishTime>i)continue;if("in_body_parser_blocking"===s.args.data.renderBlocking){const e=s.args.data.priority,t="Script"===s.args.data.resourceType;if("VeryHigh"!==e&&!(t&&"High"===e))continue}e.Trace.getNavigationForTraceEvent(s,n.frameId,t.Meta.navigationsByFrameId)===n.navigation&&r.push(s)}const s=gt(t,n,r);return r=r.sort(((e,t)=>t.dur-e.dur)),pt({relatedEvents:r,renderBlockingRequests:r,...s})},i18nString:dt,isRenderBlocking:function(e){return"RenderBlocking"===e.insightKey}});const ft=[function(e){return"MarkDOMContent"===e.name},function(e){return"MarkLoad"===e.name},function(e){return"firstPaint"===e.name},function(e){return"firstContentfulPaint"===e.name},function(e){return"largestContentfulPaint::Candidate"===e.name},function(e){return"navigationStart"===e.name&&""!==e.args?.data?.documentLoaderURL}];var ht;!function(e){e.Elapsed="elapsed (us)",e.RejectPercentage="reject_percentage",e.FastRejectCount="fast_reject_count",e.MatchAttempts="match_attempts",e.MatchCount="match_count",e.Selector="selector",e.StyleSheetId="style_sheet_id"}(ht||(ht={}));const vt={title:"CSS Selector costs",description:"If Recalculate Style costs remain high, selector optimization can reduce them. [Optimize the selectors](https://developer.chrome.com/docs/devtools/performance/selector-stats) with both high elapsed time and high slow-path %. Simpler selectors, fewer selectors, a smaller DOM, and a shallower DOM will all reduce matching costs.",matchAttempts:"Match attempts",matchCount:"Match count",elapsed:"Elapsed time",topSelectors:"Top selectors",total:"Total",enableSelectorData:"No CSS selector data was found. CSS selector stats need to be enabled in the performance panel settings."},yt=n.i18n.registerUIStrings("models/trace/insights/SlowCSSSelector.ts",vt),St=n.i18n.getLocalizedString.bind(void 0,yt);var Tt=Object.freeze({__proto__:null,UIStrings:vt,generateInsight:function(n,i){const r=n.SelectorStats;if(!r)throw new Error("no selector stats data");const s=function(t,n){const i=new Map;for(const[r,s]of t)if(r.args.beginData?.frame===n.frameId&&e.Timing.eventIsInBounds(r,n.bounds))for(const e of s.timings){const t=e[ht.Selector]+"_"+e[ht.StyleSheetId],n=i.get(t);void 0!==n?(n[ht.Elapsed]+=e[ht.Elapsed],n[ht.FastRejectCount]+=e[ht.FastRejectCount],n[ht.MatchAttempts]+=e[ht.MatchAttempts],n[ht.MatchCount]+=e[ht.MatchCount]):i.set(t,{...e})}return[...i.values()]}(r.dataForUpdateLayoutEvent,i);let a=0,o=0,c=0;s.map((e=>{a+=e[ht.Elapsed],o+=e[ht.MatchAttempts],c+=e[ht.MatchCount]}));const l=s.toSorted(((e,t)=>t[ht.Elapsed]-e[ht.Elapsed])),u=s.toSorted(((e,t)=>t[ht.MatchAttempts]-e[ht.MatchAttempts]));return d={relatedEvents:[],totalElapsedMs:t.Timing.Milli(a/1e3),totalMatchAttempts:o,totalMatchCount:c,topElapsedMs:l.slice(0,3),topMatchAttempts:u.slice(0,3)},{insightKey:"SlowCSSSelector",strings:vt,title:St(vt.title),description:St(vt.description),category:M.ALL,state:0!==d.topElapsedMs.length&&0!==d.topMatchAttempts.length?"informative":"pass",...d};var d},i18nString:St});const It={title:"3rd parties",description:"3rd party code can significantly impact load performance. [Reduce and defer loading of 3rd party code](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/loading-third-party-javascript/) to prioritize your page's content.",columnThirdParty:"3rd party",columnTransferSize:"Transfer size",columnMainThreadTime:"Main thread time",noThirdParties:"No third parties found"},_t=n.i18n.registerUIStrings("models/trace/insights/ThirdParties.ts",It),Et=n.i18n.getLocalizedString.bind(void 0,_t);function Mt(e,t){const n=[];for(const i of e)if(i.entity!==t){const e=i.relatedEvents??[];n.push(...e)}return n}var wt=Object.freeze({__proto__:null,UIStrings:It,generateInsight:function(e,t){const n=s.ThirdParties.summarizeThirdParties(e,t.bounds),i=t.navigation?.args.data?.documentLoaderURL??e.Meta.mainFrameURL,a=o.ThirdPartyWeb.getEntity(i)||r.Helpers.makeUpEntity(e.Renderer.entityMappings.createdEntityCache,i);return c={relatedEvents:Mt(n,a),firstPartyEntity:a,summaries:n},{insightKey:"ThirdParties",strings:It,title:Et(It.title),description:Et(It.description),category:M.ALL,state:c.summaries.find((e=>e.entity!==c.firstPartyEntity))?"informative":"pass",...c};var c},i18nString:Et});const bt={title:"Optimize viewport for mobile",description:"Tap interactions may be [delayed by up to 300 ms](https://developer.chrome.com/blog/300ms-tap-delay-gone-away/) if the viewport is not optimized for mobile."},Lt=n.i18n.registerUIStrings("models/trace/insights/Viewport.ts",bt),Ct=n.i18n.getLocalizedString.bind(void 0,Lt);function Pt(e){return{insightKey:"Viewport",strings:bt,title:Ct(bt.title),description:Ct(bt.description),category:M.INP,state:!1===e.mobileOptimized?"fail":"pass",...e}}var Rt=Object.freeze({__proto__:null,UIStrings:bt,generateInsight:function(t,n){const i=t.UserInteractions.parseMetaViewportEvents.find((t=>t.args.data.frame===n.frameId&&e.Timing.eventIsInBounds(t,n.bounds))),r=t.UserInteractions.beginCommitCompositorFrameEvents.filter((t=>t.args.frame===n.frameId&&(!(i&&t.ts<i.ts)&&e.Timing.eventIsInBounds(t,n.bounds))));if(!r.length)return Pt({mobileOptimized:null,warnings:[E.NO_LAYOUT]});for(const e of r)if(!e.args.is_mobile_optimized)return Pt({mobileOptimized:!1,viewportEvent:i,metricSavings:{INP:300}});return Pt({mobileOptimized:!0,viewportEvent:i})},i18nString:Ct}),Nt=Object.freeze({__proto__:null,CLSCulprits:V,Cache:z,DOMSize:te,DocumentLatency:Y,DuplicatedJavaScript:se,FontDisplay:le,ForcedReflow:fe,ImageDelivery:we,InteractionToNextPaint:Re,LCPDiscovery:ze,LCPPhases:He,LegacyJavaScript:Ge,ModernHTTP:tt,NetworkDependencyTree:ct,RenderBlocking:mt,SlowCSSSelector:Tt,ThirdParties:wt,Viewport:Rt});export{w as Common,Nt as Models,u as Statistics,b as Types};
