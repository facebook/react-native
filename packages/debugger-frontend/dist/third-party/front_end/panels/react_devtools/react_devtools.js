import*as e from"../../core/i18n/i18n.js";import*as t from"../../ui/legacy/legacy.js";import*as i from"../../core/sdk/sdk.js";import*as n from"../../third_party/react-devtools/react-devtools.js";import*as o from"../../core/common/common.js";import*as s from"../../models/workspace/workspace.js";import*as a from"../../models/bindings/bindings.js";import*as r from"../../models/logs/logs.js";import*as d from"../../core/host/host.js";import*as l from"../../models/react_native/react_native.js";class c extends i.SDKModel.SDKModel{static FUSEBOX_BINDING_NAMESPACE="react-devtools";rdtBindingsModel;constructor(e){super(e);const t=e.model(l.ReactDevToolsBindingsModel.ReactDevToolsBindingsModel);if(!t)throw new Error("Failed to construct ReactDevToolsModel: ReactDevToolsBindingsModel was null");this.rdtBindingsModel=t,t.addEventListener("BackendExecutionContextCreated",this.onBackendExecutionContextCreated,this),t.addEventListener("BackendExecutionContextUnavailable",this.onBackendExecutionContextUnavailable,this),t.addEventListener("BackendExecutionContextDestroyed",this.onBackendExecutionContextDestroyed,this),this.initialize(t)}async initialize(e){return e.enable().then((()=>this.onBindingsModelInitializationCompleted())).catch((e=>this.onBindingsModelInitializationFailed(e)))}onBindingsModelInitializationCompleted(){const e=this.rdtBindingsModel;if(!e)throw new Error("Failed to initialize ReactDevToolsModel: ReactDevToolsBindingsModel was null");e.subscribeToDomainMessages(c.FUSEBOX_BINDING_NAMESPACE,(e=>this.onMessage(e))),e.initializeDomain(c.FUSEBOX_BINDING_NAMESPACE).then((()=>this.onDomainInitializationCompleted())).catch((e=>this.onDomainInitializationFailed(e)))}onBindingsModelInitializationFailed(e){this.dispatchEventToListeners("InitializationFailed",e.message)}onDomainInitializationCompleted(){this.dispatchEventToListeners("InitializationCompleted")}onDomainInitializationFailed(e){this.dispatchEventToListeners("InitializationFailed",e.message)}onMessage(e){this.dispatchEventToListeners("MessageReceived",e)}async sendMessage(e){const t=this.rdtBindingsModel;if(!t)throw new Error("Failed to send message from ReactDevToolsModel: ReactDevToolsBindingsModel was null");return t.sendMessage(c.FUSEBOX_BINDING_NAMESPACE,e)}onBackendExecutionContextCreated(){const e=this.rdtBindingsModel;if(!e)throw new Error("ReactDevToolsModel failed to handle BackendExecutionContextCreated event: ReactDevToolsBindingsModel was null");e.isEnabled()?this.dispatchEventToListeners("InitializationCompleted"):this.initialize(e)}onBackendExecutionContextUnavailable({data:e}){this.dispatchEventToListeners("InitializationFailed",e)}onBackendExecutionContextDestroyed(){this.dispatchEventToListeners("Destroyed")}}i.SDKModel.SDKModel.register(c,{capabilities:4,autostart:!1});var h=Object.freeze({__proto__:null,ReactDevToolsModel:c});const g={title:"React DevTools",sendFeedback:"[FB-only] Send feedback"},m=e.i18n.registerUIStrings("panels/react_devtools/ReactDevToolsView.ts",g),u=e.i18n.getLocalizedString.bind(void 0,m);function p(e,t){const{sourceURL:i,line:n,column:d}=t||e;!async function(e,t,i){const n=s.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(e);if(n){const e=await a.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().normalizeUILocation(n.uiLocation(t,i));return void o.Revealer.reveal(e)}const d=a.ResourceUtils.resourceForURL(e);if(d)return void o.Revealer.reveal(d);const l=r.NetworkLog.NetworkLog.instance().requestForURL(e);if(!l)throw new Error("Could not find resource for "+e);o.Revealer.reveal(l)}(i,n-1,d-1)}class M extends t.View.SimpleView{wall;backendIsConnected=!1;bridge=null;store=null;listeners=new Set;constructor(){super(u(g.title)),this.wall={listen:e=>(this.listeners.add(e),()=>{this.listeners.delete(e)}),send:(e,t)=>this.sendMessage(e,t)},window.addEventListener("beforeunload",(()=>this.bridge?.shutdown())),i.TargetManager.TargetManager.instance().addModelListener(c,"InitializationCompleted",this.onInitializationCompleted,this),i.TargetManager.TargetManager.instance().addModelListener(c,"InitializationFailed",this.onInitializationFailed,this),i.TargetManager.TargetManager.instance().addModelListener(c,"Destroyed",this.onDestroyed,this),i.TargetManager.TargetManager.instance().addModelListener(c,"MessageReceived",this.onMessage,this),this.renderLoader()}onInitializationCompleted(){this.clearView(),this.backendIsConnected=!0,this.bridge=n.createBridge(this.wall),this.store=n.createStore(this.bridge);const e=window.matchMedia("(prefers-color-scheme: dark)").matches;n.initialize(this.contentElement,{bridge:this.bridge,store:this.store,theme:e?"dark":"light",canViewElementSourceFunction:()=>!0,viewElementSourceFunction:p})}onInitializationFailed({data:e}){this.backendIsConnected=!1,this.clearView(),this.renderErrorView(e)}onDestroyed(){this.clearView(),this.backendIsConnected=!1,this.bridge?.shutdown(),this.bridge=null,this.store=null,this.listeners.clear(),this.renderLoader()}renderLoader(){const e=document.createElement("div");e.setAttribute("style","display: flex; flex: 1; justify-content: center; align-items: center");const t=document.createElement("span");t.classList.add("spinner"),e.appendChild(t),this.contentElement.appendChild(e)}renderErrorView(e){const i=document.createElement("div");i.setAttribute("style","display: flex; flex: 1; flex-direction: column; justify-content: center; align-items: center");const n=document.createElement("div");n.setAttribute("style","font-size: 3rem"),n.innerHTML="â—";const o=document.createElement("p");if(o.setAttribute("style","user-select: all"),o.innerHTML=e,i.appendChild(n),i.appendChild(o),this.contentElement.appendChild(i),globalThis.FB_ONLY__reactNativeFeedbackLink){const e=globalThis.FB_ONLY__reactNativeFeedbackLink,n=t.UIUtils.createTextButton(u(g.sendFeedback),(()=>{d.InspectorFrontendHost.InspectorFrontendHostInstance.openInNewTab(e)}),{className:"primary-button",jslogContext:"sendFeedback"});i.appendChild(n)}}clearView(){this.contentElement.removeChildren()}wasShown(){super.wasShown(),this.registerCSSFiles([n.CSS])}onMessage({data:e}){if(e)for(const t of this.listeners)t(e)}sendMessage(e,t){if(this.backendIsConnected)for(const n of i.TargetManager.TargetManager.instance().models(c,{scoped:!0}))n.sendMessage({event:e,payload:t})}}var v=Object.freeze({__proto__:null,ReactDevToolsViewImpl:M});export{h as ReactDevToolsModel,v as ReactDevToolsView};
